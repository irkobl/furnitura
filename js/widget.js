"use strict";var _extends=Object.assign||function(e){for(var t,i=1;i<arguments.length;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e};define("widget",["jquery","U","asyncjs","i18n","history","lodash","_","logActions","widgetEditTooltip","shop/priceFormatter","billing/feature-availability","js/share/deviceHidden","js/share/widgetCommonHelper","js/share/goalsHelper","text!./html/constructor/elementsControls.html","css!/css/require/widgets/editor.css"],function(e,t,i,n,o,s,r,a,l,d,c,u,f,g,p){var h=n("constructor"),v={constructor:null,minColsTable:{audio:4,blogs:2,bloquote:2,border:1,button:2,checkout:5,contacts:4,customerInfo:5,customHtml:2,disqus:3,downloadFile:2,ecwid:12,extendedCart:12,facebookLikeBox:4,feedBack:4,gallery:4,goods:3,googlesearch:4,header:2,icon:1,imagezoom:2,instagram:3,mailchimp:4,mainmenu:12,maps:4,menu:12,newsInformer:6,odnoklassnikiLikeBox:4,payment:5,pinterest:3,price:8,productCard:3,review:4,shipping:5,sliderWysiwyg:6,slideshare:4,social:2,socialGroups:4,spacer:1,stages:3,table:6,handsOnTable:6,timeline:6,timer:4,twitterLikeBox:4,ucalc:4,video:4,weather:3,wysiwyg:2,yandexSearch:6},dropPosition:{liveChat:{fixed:!0,position:{bottom:["left","right"]}},jivosite:{fixed:!0,position:{bottom:["left","right"]}},liveTex:{fixed:!0,position:{bottom:["left","right"],center:["left","right"]}},backCall:{fixed:!0,position:{special:["left","right"]},type:"special"},addThisShareBar:{fixed:!0,position:{center:["left","right"]}},uSocial:{fixed:!0,position:{center:["left","right"]}},liveAgent:{fixed:!0,position:{bottom:["left","right"]}},cart:{fixed:!0,position:{top:["left","right"]}}},dependentWidgetListFeature:{productCard:"shop",cart:"shop",extendedCart:"shop",customerInfo:"shop",shipping:"shop",payment:"shop",checkout:"shop",customHtml:"customHtml"},widgetsHaveAttrs:t.params.widgetsHaveAttrs,panellessWidgets:["wysiwyg"],widgetsCollectionFull:!1,waitWidgets:[],widgetsCollection:{},get:function(){return function(e){return this.widgetsCollection[e]}}(),put:function(){return function(e,t){this.widgetsCollection[e]=t}}(),remove:function(){return function(e){delete this.widgetsCollection[e]}}(),map:t.params.widgetsMap,defaultOpts:{addListeners:!0,initWidgetsOnLoad:!1},$body:e("#body"),inited:!1,idWidget:null,onRemove:function(){return function(t){return t.length&&!t.closest("header, footer").length&&v.widgetsCollectionFull?(e(".js-back-click").attr("data-type-block")&&e(".ul-disabled-overlay").trigger("click.constructor"),e(".ul-disabled-container-overlay").length&&e(".ul-disabled-container-overlay").trigger("click"),e(".ul-tooltip-wrapper").addClass("ul-tooltip-hidden"),1===t.closest(".ul-container").find(".ul-widget").length&&t.closest(".ul-container").find(".ul-drag-handle-container").addClass("ul-drag-handle-container-hidden"),t.addClass("js-w-remove"),!0):void 0}}(),isHiddenDeviceWidget:function(){return function(e){var t=e.attr("data-device-hidden"),i={};if(t){try{t=JSON.parse(t)}catch(n){console.error("deviceHidden JSON parse failed")}return i={desktop:{opts:{isHidden:t.desktop||!1}},tablet:{opts:{isHidden:t.tablet||!1}},phone:{opts:{isHidden:t.phone||!1}}}}}}(),_getSiblingResize:function(){return function(t,i){var n=this,o=function(){return function(t,i){var o=null,s=e(r[t]),a=n.constructor.REG_CLASS_SM.exec(s.attr("class"));if(a){var l=parseInt(a[1]);0!==l&&l===i&&(o=s)}return o}}(),s=t.attr("id"),r=t.closest(".ul-row").children(".ul-col:not(.col-sm-0)"),a=void 0;if(e.each(r,function(t,i){e(i).attr("id")===s&&(a=t)}),"undefined"!=typeof a){var l=void 0,d=void 0,c=0;if(1&a){for(var u=a-1;u>=0&&(l=o(u,i),!l);u--);if(c=1,l&&!l.length){for(var u=l.index(),f=void 0,g=u-1;g>=0;g--)f=o(g,i);f&&(l=null)}(l&&0===l.index()||6===i)&&(d=l)}else for(var u=a+1;u<=r.length&&(d=o(u,i),!d);u++);if(!d&&!c)for(var u=a-1;u>=0&&(d=o(u,i),!d);u--);if(!d&&c)for(var u=a+1;u<=r.length&&(d=o(u,i),!d);u++);return d}}}(),init:function(){return function(i){var n=this,o=this;o.inited&&o.destroy(),o.inited=!0,o.widgetsCollection={};var s=e.extend({},o.defaultOpts,i);if(o.site=s.site,o.templateId=s.templateId,o.constructor=s.constructor,!!s.addListeners){window.signals.removeWidget.listen(function(t,i){return new Promise(function(o){var s=e("#"+t);i.controls="mer",i.options=i.opts,delete i.opts,n.onRemove(s)&&n.constructor.removeWidget(s,o,!0,!1,!0,i)})});var r=t.delay(function(e){v.constructor.copyWidget(e.$w,e.w)},o,500);o.$body.on("mouseenter.widgetHover",".ul-widget",{me:o},o.eventWidgetHoverEnter).on("mouseleave.widgetHover",".ul-widget, .ui-resizable-handle",{me:o},o.eventWidgetHoverLeave).on("click.widgets",".ul-w-btn-field, .js-field-el",function(t){var i=v.get(e(this).closest(".ul-widget").attr("id"));i.openFieldsDialog(),t.stopPropagation()}).on("click.widgets",".js-copy-el",function(i){if(v.widgetsCollectionFull){var n=v.get(e(i.target).closest(".ul-widget").attr("id"));"true"===n.$el.attr("data-single-widget")||n.$el.parent().hasClass("ul-absolute-widgets")||(e(i.target).trigger("mouseleave"),r({$w:e(n.$el.closest(".ul-row")),w:n}),t.page.isHover(i))}}).on("click.widgets",".js-remove-el",function(i){var n=e(this).closest(".ul-widget");o.onRemove(n)&&(o.constructor.removeWidget(n),t.page.isHover(i))}).on("click.widgets",".js-device-hide-el",function(t){var i=e(this).closest(".ul-widget");o.constructor.hideShowNode(t,i,"hideWidget")}).on("click.widgets",".js-full-col",function(){if("tablet"===t.constructor.deviceMode.device){var i=e(this).closest(".ul-col"),n=o._getSiblingResize(i,12);o.constructor.setColSize(i,n,6,6)}}).on("click.widgets",".js-not-full-col",function(){if("tablet"===t.constructor.deviceMode.device){var i=e(this).closest(".ul-col"),n=o._getSiblingResize(i,6);o.constructor.setColSize(i,n,12,12)}}).on("beforeChangePage",function(){var t=e(this).data("widgetType")||null;e(".ul-popup-overlay",o.$body).length&&"mainmenu"!==t&&e(".ul-popup-overlay",o.$body).click()}).on("click.widgets",'.ul-widget > .ul-elements-controls:not([data-overlay="false"])',o.widgetOverlayEdit.bind(o))}}}(),widgetOverlayEdit:function(){return function(i){var n=this,o=e(i.target);if(!o.closest(".ul-elements-handler").length){var s=o.closest(".ul-widget"),r=v.get(s.attr("id"));null!=r&&(n.constructor.activeDrag||n.constructor.activeResize||n.constructor.activeAutocrop||(t.cancelCurrentEdit(function(){}),n.isWidgetAllowedEdit(r.widgetName,function(e){e&&r.edit(i)})))}}}(),widgetNotOvelayEdit:function(){return function(t,i){var n=this;e(document).on("mousedown."+t,i,function(i){var o=e(this),s=e(i.target),r=null;s.closest(".ul-elements-handler").length||s.closest(n.noClickClass).length||o.hasClass("js-w-remove")||n.isWidgetAllowedEdit(t,function(e){return r=v.get(o.attr("id")),e?void(!r||r.isEditing||!n.constructor.activeDrag&&!n.constructor.activeResize&&!n.constructor.activeAutocrop&&r.edit(s)):(r.destroy=r&&r.destroy?r.destroy:function(){},r.destroy(),void i.preventDefault())})})}}(),isWidgetAllowedEdit:function(){return function(e,t){var i=this;if(t=t||function(){},i.dependentWidgetListFeature[e]){var n=i.dependentWidgetListFeature[e];require(["billing/feature-availability"],function(e){e.check(n,{},function(e){t(e)})})}else t(!0)}}(),eventWidgetHoverEnter:function(){return function(i){var n=i.data.me,o=e(this),s=e(".ul-elements-controls",o);if(!s.hasClass("js-off-hover")&&!o.data().edit){var r=e(".ul-elements-drag",s),a=e(".js-device-hide-el",s);"desktop"!==t.constructor.deviceMode.device||o.closest("#ul-id-special-404_block, header, footer").length?(r.css("display","none"),a.css("display","inline-block")):(r.css("display","inline-block").closest(".ul-elements-controls-nodrag").removeClass("ul-elements-controls-nodrag"),a.css("display","none"));var l=o.closest("header");if(!n.constructor.activeDrag||!n.constructor.activeResize){Object.keys(n.widgetsCollection).length&&v.AddElementsControls(o),s.removeClass("ul-elements-controls-visible");var d=e("#body-fict"),c=e(".ul-elements-handler, .ul-handlers-auto-position",o);if(c.length){var u=o.closest(".ul-absolute-widgets");if(c.length&&!u.length){c.css({"margin-left":0});var f=c.offset(),g=d.offset();if(f.left+c.width()>g.left+d.width()){var p=g.left+d.width()-(f.left+c.width());c.css("margin-left",2*p)}if(f.left<g.left){var p=g.left-f.left;c.css("margin-left",2*p)}}if(o.closest("header").length&&20>o.offset().top&&s.length){e(".ul-elements-controls",o).attr("data-position","bottom");var f=c.offset().top+e("#ul-main").scrollTop()+c.height(),g=l.offset().top+l.height();f>g&&c.css({"margin-bottom":0})}o.closest("footer").length&&20>Math.abs(o.closest("footer").offset().top-o.offset().top)&&s.length&&s.attr("data-position","bottom"),c=e(".ul-elements-handler",o),c.length&&!u.length&&(c.offset().left<e("#body").offset().left&&(c.parent().css({"align-items":"flex-start"}),c.css({"margin-left":-15})),c.width()+c.offset().left>e("#body").width()+e("#body").offset().left&&(c.parent().css({"align-items":"flex-end"}),c.css({"margin-right":-15})));var h=s.closest(".ul-col"),m=!h.nextAll(".ul-col").not(".js-hide-all-w").first().length,w=e(".ul-elements-controls-btns .js-not-full-col",s),y=e(".ul-elements-controls-btns .js-full-col",s);m?(w.css({display:"none"}),y.css({display:"none"})):(w.css({display:""}),y.css({display:""})),s.addClass("ul-elements-controls-visible"),o.closest(".ul-widget").attr("id")!==n.idWidget&&e("#"+n.idWidget).find(".ul-elements-controls-visible").removeClass("ul-elements-controls-visible")}}}}}(),eventWidgetHoverLeave:function(){return function(t){var i=t.data.me;if(!e(this).find(".ul-elements-controls-visible").hasClass("js-off-hover")&&(!e(this).hasClass("ul-widget")||e(this).closest(".ul-widget").attr("data-widget"))&&(!i.constructor.activeDrag||!i.constructor.activeResize)){var n=e(t.relatedTarget);if(n.hasClass("ul-resizable-view ")||n.hasClass("ui-resizable-handle"))return i.idWidget=e(this).closest(".ul-widget").attr("id"),!1;if(e(this).hasClass("ul-widget")&&(i.idWidget=e(this).closest(".ul-widget").attr("id"),e(this).find(".ul-not-device-resize").removeClass("ul-not-device-resize"),e("#"+i.idWidget).find(".ul-elements-controls-visible").removeClass("ul-elements-controls-visible")),n.hasClass("ul-col")&&e(t.target).hasClass("ui-resizable-handle")){var o=e("#"+i.idWidget);o.find(".ul-not-device-resize").removeClass("ul-not-device-resize"),o.find(".ul-elements-controls-visible").removeClass("ul-elements-controls-visible")}}}}(),destroy:function(){return function(){var t=this;t.$body.off(".widgets").off(".widgetHover").off("click.back").off("beforeChangePage"),e.each(this.widgetsCollection,function(e){t.widgetsCollection[e]&&(t.widgetsCollection[e].destroy(),t.widgetsCollection[e].$el&&(t.widgetsCollection[e].$el.empty(),t.widgetsCollection[e].$el.remove(),null===t.widgetsCollection[e].$el),delete t.widgetsCollection[e]),delete t[e],delete t[e]||console.log("Can't cleanup previous widget: ",e)}),t.widgetsCollection={}}}(),changeField:function(){return function(t,i,n){e.each(this.widgetsCollection,function(e,o){o.field===t&&e!==n&&o._update(i)})}}(),getFieldData:function(){return function(i,n){e.ajax({url:"/sites/url/"+t.params.site+"/fieldData/"+i,type:"get",api:!0,ok:function(){return function(e){n(e)}}()})}}(),getTypeWidgetField:function(){return function(t){var i=!1;return e.each(v.widgetsCollection,function(e,n){n.type===t&&n.field&&(i=n.field)}),i}}(),getWidgetsByField:function(){return function(t){var i=[];return e.each(v.widgetsCollection,function(e,n){n.field===t&&i.push(n)}),i}}(),getWidgets:function(){return function(e){this.widgetsCollectionFull?e(this.widgetsCollection):this.waitWidgets.push(e)}}(),setWidgetsCollectionFull:function(){return function(){var t=this;this.widgetsCollectionFull=!0,e(window).trigger("widgetsCollectionFull"),this.waitWidgets.forEach(function(e){e(t.widgetsCollection)}),this.waitWidgets=[]}}(),_getListTextWidget:function(){return function(){return{wysiwyg:1,header:1,goods:1,button:1,bloquote:1,productCard:1,checkout:1,extendedCart:1}}}(),getTemplateControls:function(){return function(e){var i={widgetTitle:"",customClasses:[],copy:!1,dataOverlay:!0,isAbs:!1,isSingle:!1,isTemplateMaster:t.params.isTemplateMaster,pageType:t.params.pageType,pageIsEditable:t.params.pageIsEditable,specialBlogRemove:!1,__:n,hasFieldClasses:!1,hasDrag:!1,headerFooter:!1,hasRemoveIcon:!0,hideAllRemoveIcon:!1};return r.template(p)(r.defaults(e,i))}}(),getElementControls:function(){return function(i){var n=i.$el,o=i.controls,s=void 0===o?"":o,r=i.hasDrag,a=!0,l=!0,d=this._getListTextWidget(),c=n.data("widget");n.closest("header, footer").length&&(l=!1),d[c]&&(a=!1);var u=[];t.params.isTemplateMaster&&u.push("ul-has-field");var f=n.data("data");f||(f={abs:n.data("drop-position-fixed")});var g=-1!==s.indexOf("r"),p="blog"===t.params.pageType||"special"===t.params.pageType||"shop"===t.params.pageType;f&&f.abs&&p&&(g=!1);var v=!1;(!g&&n.closest("#ul-id-special-404_block").length||"shop"===t.params.pageType)&&(v=!0);var m=this.get(n.attr("id")),w=[];m&&m.data&&m.data.customClasses&&(w=m.data.customClasses);var y=this.getTemplateControls({customClasses:w,copy:!~s.indexOf("u"),isAbs:n.parent().hasClass("ul-absolute-widgets"),isSingle:"true"===n.attr("data-single-widget"),specialBlogRemove:!1,widgetTitle:h("widgets."+c+".name"),dataOverlay:a,hasFieldClasses:u,hasDrag:void 0!==r&&r,headerFooter:l,hasRemoveIcon:g,hideAllRemoveIcon:v});return e(y)}}(),renderElementControls:function(){return function(i){var n=i.data("controls");if(n){var o=e(".js-elements-controls",i),s=n.includes("m");if(o.length)return void(s||o.addClass("ul-elements-controls-nodrag"));if(t.constructor.deviceMode.isPanelConstructorEditable||(s=!1),!this.constructor||this.constructor.activeResize||i.data("active")||i.data("edit")||!i.hasClass("ul-widget")||this.constructor.activeDrag){var r=e(".js-elements-controls",i);!s&&r.length&&r.addClass("ul-elements-controls-nodrag")}else{var r=this.getElementControls({$el:i,controls:n,hasDrag:s});i.append(r)}}}}(),AddElementsControls:function(){return function(t){var i=this;t.each(function(){i.renderElementControls(e(this))})}}(),factory:function(){return function(t,i){var n=this;requirejs(["widget-"+t+"-edit"],function(o){null==v[t]?(o=e.extend(!0,n.getInheritObject({type:t}),o),v[t]=o,o.init(),a.add({fromFile:"js/edit/widget.js",title:"widget init",desc:"widgetName: "+o.widgetName})):n.getIngeritedUrls(v[t],{type:t}),i(v[t])})}}(),factoryWidgetInstance:function(){return function(t,i,n){var o=this,s={type:t,$el:e(i.$el)},a=r.extend({},i,s);["id","type","$el"].forEach(function(e){var t="$el"===e?i:a;if(void 0===t[e]||null===t[e])throw"Error, key "+e+" not exist"}),o.factory(t,function(e){var t=e._new(a);o.put(t.id,t),n(t)})}}(),getIngeritedUrls:function(){return function(e,i){e.dataUrl=t.sprintf("/sites/url/{site}/pages/id/{page}/widgets/{widget}/getData",[t.params.site,t.params.page,i.type]),e.defaultDataUrl=t.sprintf("/sites/url/{site}/pages/id/{page}/widgets/{widget}/getDefaults",[t.params.site,t.params.page,i.type]),e.saveUrl=t.sprintf("/sites/url/{site}/pages/id/{page}/widgets/{widget}/save",[t.params.site,t.params.page,i.type])}}(),getInheritObject:function(){return function(e){var t=Object.create(this.proto);return this.getIngeritedUrls(t,e),t.controls="mer",t.widgetName=e.type,t}}(),proto:{data:null,options:null,designs:null,minCols:2,noClickClass:".ul-elements-controls",canChangeDesign:function(){return function(){return t.params.isTemplateServer||0<this.$el.closest("#ul-content").length}}(),destroy:function(){return function(){throw new Error("No destroy "+this.type)}}(),_new:function(){return function(e){var t=Object.create(this);return t.id=e.id,t.type=e.type,t.$el=e.$el,t.controls=e.controls,t._new=!0,e.data&&(t.data=e.data),e.options&&(t.options=e.options),e.product&&(t.product=e.product),null!=e.field&&(t.field=e.field),t}}(),update:function(){return function(){}}(),_update:function(){return function(e){this.data=e,this.update()}}(),getDesigns:function(){return function(e){var t=this;require(["json!/api/templates/"+v.templateId+"/listdesigns/"+this.type],function(i){v[t.type].designs=i,e(null,i)})}}(),getPartialSettings:function(){return function(i){var n=this;n.controls&&~n.controls.indexOf("m")?(n.partialSettings={},i(null,{})):e.getJSON(t.sprintf("/sites/url/{siteUrl}/displayPartialWidgets",[t.params.site]),function(e){n.partialSettings=e,i(null,e)})}}(),getUrl:function(){return function(e){return t.sprintf("/sites/url/{site}/pages/id/{page}/widgets/{widget}/"+e,[t.params.site,t.params.page,this.widgetName])}}(),_getTemplate:function(){return function(e){var i=this;require(["text!/static/widget/"+this.type+"/getBlank?templateId="+t.params.template],function(t){v[i.type].template=t,e(null,t)})}}(),getAttributes:function(){return function(e){var t=this;return v.widgetsHaveAttrs[t.type]?void require(["/js/share/widgets/"+t.type+"/attrs.js"],function(i){v[t.type].attrs=i,e(null,i)}):void e(null,null)}}(),_loadDefaults:function(){return function(t){var i=this;null==v[i.type].defaults?e.ajax({url:i.defaultDataUrl,data:{widgetId:i.id},type:"post",api:!0,ok:function(){return function(n){v[i.type].defaults={data:n.data,options:n.opts||n.options},n.fieldPath&&(i.field=n.fieldPath,v[i.type].defaults.fieldPath=n.fieldPath),i.data=i.data||e.extend(!0,{},n.data),i.options=i.options||e.extend(!0,{},n.opts||n.options),t()}}(),noOk:t}):(i.data=i.data||e.extend(!0,{},v[i.type].defaults.data),i.options=i.options||e.extend(!0,{},v[i.type].defaults.options),v[i.type].defaults.fieldPath&&(i.field=v[i.type].defaults.fieldPath),t())}}(),_initView:function(){return function(e){var t=v.get(e);t._old||t._fetchDataOptions(),this.initView(t.id)}}(),initView:function(){return function(){}}(),scrollIntoView:function(){return function(t){var i="number"==typeof t?t:0,n=this.$el.offset();this.$el.position()&&n&&e("html,body").stop().animate({scrollTop:n.top-i},500)}}(),getRenderParams:function(){return function(e){var t=this,i={};return"function"==typeof t._getRenderParams?void t._getRenderParams(function(t,n){e(t,s.merge(i,n||{}))}):void e(null,i)}}(),render:function(){return function(e){var t=this,n=v.getTypeWidgetField(t.type);i.parallel({data:function(){return function(e){!1!==n&&n===t.type&&t.addBlockWidget?t._loadDefaults(e):t.data?e():t._loadDefaults(e),t.addBlockWidget=!1}}(),template:function(){return function(e){t._getTemplate(e)}}(),designs:function(){return function(e){t.getDesigns(e)}}(),partialSettings:function(){return function(e){t.getPartialSettings(e)}}(),attributes:function(){return function(e){t.getAttributes(e)}}()},function(i,n){t.getRenderParams(function(i,o){n.template&&(t.template=n.template),t.__renderParams=o,t._overlayReinit(),e&&(e(),a.add({fromFile:"js/edit/widget.js",title:"render widget",desc:"id: "+t.id+". type: "+t.type}))})})}}(),_handlerRender:function(){return function(e){var i=this,n=e.widgetHtml,o=e.widgetAttrs,s={mediaParams:v.isHiddenDeviceWidget(this.$el),constructorMode:void 0!==t.params},a=u.getHiddenDeviceParams(s),l=new f({widget:this,widgetAttrs:o,hiddenDeviceParams:a});if(r.isString(n))return l.render(n);var d=l.dataAttrs;Object.keys(d).forEach(function(e){i.$el.attr(e,d[e])})}}(),handlerRender:function(){return function(){var i=this;this.getAttributes(function(){if(!i.attrs)return void i.render();e(".js-elements-controls",i.$el).remove(),r.isFunction(i.onBeforeRender)&&i.onBeforeRender();var n=_extends({},i),o=i.attrs;n.opts=n.options,n.handlerClass=".js-elements-controls",n.designMap=v[i.type].designs,n.lang=t.getCookie("i18n"),n.isConstructor="undefined"!=typeof t.params,n.previewMode=window.previewMode,n.backupPreviewMode=window.backupPreviewMode;var s=new o(n);i._handlerRender({widgetAttrs:s}),v.getElementControls({$el:i.$el,controls:i.$el.data("controls"),hasDrag:!0}).appendTo(i.$el),r.isFunction(i.initView)&&i.initView(i.id,i.options),r.isFunction(i.onAfterRender)&&i.onAfterRender()})}}(),_commonRender:function(){return function(t){r.isFunction(this.onBeforeRender)&&this.onBeforeRender();var i=this._render(t),n=i.widgetHtml,o=i.widgetAttrs;if(o){var s;s=e(r.isString(n)?this._handlerRender({widgetHtml:n,widgetAttrs:o}):this._handlerRender({widgetHtml:this.$el.html(),widgetAttrs:o})),t&&!s.data("dropPositionFixed")&&s.addClass("ul-disabled-overlay-element"),window.widgetInfo[this.type].version===window.widgetVersion.REACT||window.widgetInfo[this.type].version===window.widgetVersion.REACT_WRAPPER?this.$el.html(s):(this.$el.replaceWith(s),this.$el=s),r.isFunction(this.initView)&&this.initView(this.id,this.options),r.isFunction(this.onAfterRender)&&this.onAfterRender()}}}(),_render:function(){return function(i,o){var s=this,a="";o=o||function(){},s.onBeforeRender&&!s.attrs&&s.onBeforeRender(),s.data=JSON.parse(JSON.stringify(s.data)),v.dropPosition[s.type]&&v.dropPosition[s.type].fixed&&(a=s.$el.parent().attr("data-position"),s.data.party=a);var l=r.extend({__:n,_id:s._id,absPosition:a,id:s.id,lang:t.getCookie("i18n"),overlay:i,isConstructor:"undefined"!=typeof t.params,previewMode:window.previewMode,backupPreviewMode:window.backupPreviewMode,canChangeDesign:!1,controls:s.controls,opts:s.options,mediaParams:v.isHiddenDeviceWidget(s.$el),designMap:v[s.type].designs,activePageUrl:t.params.page,isULanding:t.params.isULanding,hidden:s.partialSettings[s.id],hiddenDeviceAttr:{},hiddenDeviceClass:"",data:s.data,schemaOrg:{organizationName:t.params.fieldSiteName||"",organizationType:t.params.schemaOrg&&t.params.schemaOrg[t.params.subjectId]?t.params.schemaOrg[t.params.subjectId]:"Organization"},renderGoalsHandlers:function(){return function(){return""}}(),forwardGoalsData:function(){return function(){return""}}()},s.__renderParams),d=void 0;if(s.attrs){var c=s.attrs;d=new c(l)}var u=r.template(s.template,l),f=e(u);return s.attrs||(i&&!f.data("dropPositionFixed")&&f.addClass("ul-disabled-overlay-element"),window.widgetInfo[s.type].version==window.widgetVersion.REACT||window.widgetInfo[s.type].version==window.widgetVersion.REACT_WRAPPER?s.$el.html(f):(s.$el.replaceWith(f),s.$el=f),s.initView&&s.initView(s.id,s.options),s.onAfterRender&&s.onAfterRender()),{widgetHtml:u,widgetAttrs:d}}}(),_overlayReinit:function(){return function(){var e=this,t=e.$el.hasClass(e.overlay.elClassName),i=e.$el.data("edit");e.attrs?e._commonRender(i):e._render(i),e.$el.data("edit",i),t&&e.$el.addClass(e.overlay.elClassName),!e.initView||e.wizardInitDone||e.$el.data("edit")||v.AddElementsControls(e.$el)}}(),_fetchDataOptions:function(){return function(){var e=this;e._old={data:s.cloneDeep(e.data),options:s.cloneDeep(e.options)}}}(),__save:function(){return function(i){var n=this;i||(i=function(){return function(){}}()),n._fetchDataOptions();var o={options:n.options,data:n.data};e(Object.keys(o)).each(function(e,t){"string"!=typeof o[t]&&(o[t]=JSON.stringify(o[t]))});var s=v.get(n.id);s&&null!=s.field&&(v.changeField(s.field,n.data,n.id),v[n.type].defaults&&v[n.type].defaults.fieldPath&&(v[n.type].defaults.data=n.data)),o.widgetId=n.id,t.enqueueAjax({url:n.getUrl("save"),data:o,parallel:!0,cb:i.ok(function(e){var t=e[0],o=e[1];if(t)throw new Error(t);s.field&&o.fields&&o.fields[n.type]&&v[n.type].defaults?(v[n.type].defaults.fieldPath&&(v[n.type].defaults.data=o.fields[n.type]),i(null,e)):i(null,e)}),lastId:v.constructor.lastId,retryRequest:3})}}(),save:function(){return function(e){var t=this,i=t.id,n=s.cloneDeep(t.data),r=s.cloneDeep(t.options);t._old||t._fetchDataOptions();var l=t._old;l&&l.data&&delete l.data.editingMode,delete n.editingMode,l&&JSON.stringify(n)==JSON.stringify(l.data)&&JSON.stringify(r)==JSON.stringify(l.options)?t.__save(e):(o.pushAndExec({act:"widgetSave",data:{id:i,__t:t.type,old_data:l.data,old_options:l.options,data:n,options:r}},e),a.add({fromFile:"js/edit/widget.js",title:"widget save",desc:"id: "+t.id+". type: "+t.type}))}}(),immediateSave:function(){return function(){this.defferedTimeout=null,this.save()}}(),defferedSave:function(){return function(){var e=this;this.defferedTimeout&&clearTimeout(this.defferedTimeout),this.defferedTimeout=setTimeout(function(){e.save(),e.defferedTimeout=null},500)}}(),setData:function(){return function(e){this.data=e}}(),setOptions:function(){return function(e){this.options=e}}(),openFieldsDialog:function(){return function(){var e=this;require(["json!/sites/url/"+t.params.site+"/fields","panelDialog"],function(t,i){e.overlay.show({$el:e.$el,autohide:!0,close:function(){return function(){i.hide()}}()}),i.show({context:e,title:"Установить ссылку",templateUrl:"/html/constructor/fieldDialog.html",required:["fieldsDialog"],templateData:{fields:Object.keys(t).filter(function(i){return t[i].ctrl==e.type}),curField:e.field||"none"},apply:function(){return function(t){t&&e.setField(t)}}(),beforeClose:function(){return function(){}}()})})}}(),setField:function(){return function(i){var n=this;e.ajax({url:"/sites/url/"+t.params.site+"/pages/id/"+t.params.page+"/widgets/"+n.type+"/setField",type:"post",data:{widgetId:n.id,field:i},api:!0,ok:function(){return function(e){"none"==i?delete n.field:n.field=i,n.data=e.data,n.options=e.options,n.render()}}()})}}(),widgetAbsWrapSize:function(){return function(t){e(t).closest(".ul-absolute-widgets").css({height:e(t).outerHeight(!0)}),e(t).css("height","100%")}}(),overlay:{elClassName:"ul-disabled-overlay-element",$el:null,$parent:e("#body"),show:function(){return function(i){var n=this;if(e(".js-back-click").attr("data-type-block")&&e(".ul-disabled-overlay").trigger("click.constructor"),e(".js-back-click").attr("data-type-edit-headerFooter")&&e(".ul-disabled-overlay-headerFooter").trigger("click.constructor"),v.$body.attr("data-controls","edit"),"undefined"!=typeof v.constructor.isConstructor){var o=v.get(i.$el.attr("id"));if(o&&o._fetchDataOptions(),i.$el.data("edit",!0),n.opt=e.extend({$el:null,autohide:!0,close:function(){return function(){}}(),afterShow:function(){return function(){}}(),beforeClose:function(){return function(){}}()},i),null!=n.opt.$el){e('<div class="ul-disabled-overlay">').appendTo(n.$parent),n.$el=e(".ul-disabled-overlay",n.$parent),n.opt.$el.addClass(n.elClassName),e(".ul-absolute-widgets:not(:has(.ul-disabled-overlay-element))").css("display","none"),n.opt.$el.parent().hasClass("ul-absolute-widgets")&&n.$el.css("background","rgba(0, 0, 0, 0.5)"),n.opt.autohide&&(e(".js-main").on("click.overlayEvents",function(t){e(t.target).hasClass("js-main")&&(n.opt.asyncBeforeClose?n.opt.asyncBeforeClose(function(){n.hide()}):n.hide())}),n.$el.on("click.overlayEvents",function(){n.opt.asyncBeforeClose?n.opt.asyncBeforeClose(function(){n.hide()}):n.hide()}),t.layers.on(0,function(){n.opt.close(),n.hide()})),v.constructor.destroyResizable(n.opt.$el.closest(".ul-col"));var s=i.$el.attr("data-widget")||i.$el.attr("type");0>v.panellessWidgets.indexOf(s)&&setTimeout(function(){return l.show()},100),e(document).data("disableCtrlZ",!0),o&&e(document).data("widgetType",o.type),a.add({fromFile:"js/edit/widget.js",title:"overlay open",desc:"widget: "+i.$el.attr("data-widget")}),n.opt.afterShow()}}}}(),hide:function(){return function(){var i=this;i.opt.beforeClose(),i.opt.autohide&&t.layers.off(),i.opt.close(),e("."+i.elClassName).removeClass(i.elClassName),e(".ul-absolute-widgets").show(),v.$body.removeAttr("data-controls"),e("#"+i.opt.$el.attr("id")).data("edit",!1),i.opt.autohide&&i.$el.off(".overlayEvents"),i.$el.remove(),i.opt.$el.parent().hasClass("ul-absolute-widgets")&&i.$el.css("background","");var n=v.get(i.opt.$el.attr("id"));n&&n.close&&n.close(),e(window).trigger("endWidgetEdit"),e(".js-main").off(".overlayEvents"),t.cancelCurrentEdit(function(){}),e(document).data("disableCtrlZ",!1).data("widgetType",null),a.add({fromFile:"js/edit/widget.js",title:"overlay hide"})}}()}},autocrop:function(){return function(){}}()};return o.regAction(null,{act:"widgetSave",undo:function(){return function(e,t,i){var n=v.get(t.id);n.data=t.old_data,n.options=t.old_options,n.render(i("render")),n.__save(),a.add({fromFile:"js/edit/widget.js",title:"history undo"})}}(),redo:function(){return function(e,t,i,n){var o=v.get(t.id);o.data=t.data,o.options=t.options,n||o.render(i("render")),o.__save(),a.add({fromFile:"js/edit/widget.js",title:"history redo"})}}()}),v});
//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map

//# sourceMappingURL=widget.js.map
