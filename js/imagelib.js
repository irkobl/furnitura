"use strict";var _extends=Object.assign||function(a){for(var e,i=1;i<arguments.length;i++)for(var t in e=arguments[i])Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t]);return a};define("imagelib",["U","jquery","_","uploader","sprintf","tpl!imagelib/layout","tpl!imagelib/page","tpl!imagelib/socialLayout","tpl!imagelib/social","tpl!imagelib/image","i18n","ul-framework","logActions","css!/css/require/imagelib.css"],function(a,e,i,t,o,s,l,n,r,c,d,u,g){var m={cssDeps:["css!/css/require/imagelib.css"],vars:{},$el:null,uploaderInit:!1,init:function(){return function(){var t=this;t.i18n=d("constructor.imagelib"),t.__=d,t.vars.pages={},t.vars.$containerBlock=e(t.opt.appendTo||"body"),t.vars.$containerBlock.append(e(i.template(s,{__:t.i18n}))),t.$el=t.vars.$containerBlock.find("#ul-imagelib"),t.vars.$body=e(".ul-imagelib-pages",t.$el),t.vars.$nav=e(".js-imagelib-nav",t.$el),t.vars.$done=e(".ul-imagelib-done",t.$el),t.vars.$conut=e(".ul-imagelib-count",t.$el),t.currentStockOffset=0,t.stockDefaultLimit=102,t.vars.$nav.find("li").on("click.imagelib",function(){t._page(e(this).data("nav"))}),t.vars.$containerBlock.append('<div id="ul-imagelib-preview"><p><img src=""></p></div>'),t.vars.$preview=t.vars.$containerBlock.find("#ul-imagelib-preview"),t._setUploader(),t._show(),t._loadData(function(){t.$el.find(".ul-imagelib-content").removeClass("ul-loading-indicator"),t._page(t.opt.page)}),t.vars.$done.click(function(){t.vars.$conut.hide().find("span").html(0),t.vars.$done.attr("disabled","disabled"),e(".ul-imagelib-loading",t.$el).fadeIn(),e.ajax({url:a.sprintf("/sites/url/{site}/imageLib/saveRemoteImages",[a.params.site]),method:"post",data:{images:t.vars.images},api:!0,ok:function(){return function(e){t._addUploaded(e.images),t.opt.apply(e.images),t._hide(),a.layers.off(t._hide)}}()})}),t.vars.$conut.find("a").click(function(){return t._clearSelectedImages(),!1}),e(".ul-imagelib-close",t.$el).click(function(){t._hide(),a.layers.off(t._hide)}),t.$el.on("mousedown.imagelib",function(i){e(i.target).closest(".ul-imagelib-content").hasClass("ul-imagelib-content")||(a.layers.off(t._hide),t._hide())}),t.vars.$containerBlock.on("click.imgLib",".ul-imagelib-img-list li",function(){t._setSelectedImages(e(this))}).on("dblclick.imgLib",".ul-imagelib-img-list li",function(){t.opt.multiSelect||(t._clearSelectedImages(),t._setSelectedImages(e(this)),t.vars.$done.click())}).on("click.imgLib",".ul-imagelib-img-list-actions__control",function(i){i.stopPropagation();var o=e(this).parents("li"),s=o.find(".ul-imagelib-img").data("img"),l=o.find(".ul-imagelib-img").data("_id");e(this).hasClass("ul-imagelib-img-list-actions-remove")&&e.ajax({url:a.sprintf("/sites/url/{site}/imageLib/remove",[a.params.site]),method:"post",data:{src:s,_id:l},api:!0,ok:function(){return function(){o.hasClass("active")&&t._setSelectedImages(o),o.remove(),--t.vars.pages.loaded.visible,0>t.vars.pages.loaded.visible&&(t.vars.pages.loaded.visible=0),t.vars.pages.loaded.data.filter(function(a,e){a.origin===s&&t.vars.pages.loaded.data.splice(e,1)}),t._checkEmptyLoaded()}}()}),e(this).hasClass("ul-imagelib-img-list-actions-zoom")&&(a.layers.on(2,e.proxy(t._hidePreview,t)),t.vars.$preview.addClass("ul-imagelib-preview-show").find("img").attr("src",o.find(".ul-imagelib-img").data("img")))}).on("click.imgLib","#ul-imagelib-preview",function(e){"IMG"!==e.target.tagName&&(a.layers.off(t._hidePreview),t._hidePreview())}).on("loadImg.imgLib",function(a,e){t._addUploaded(e.result)}).on("change.imgLib","#js-photostock-select",function(){var a=e(this).parent().attr("disabled","disabled"),i=e(this).val();e("#js-photostock-search",t.$el).val(""),e("[data-page=stock]",t.vars.$body).addClass("loading"),t._loadStockPhotos("/api/depositphotos/categories/"+i,0,function(){a.removeAttr("disabled"),e("[data-page=stock]",t.vars.$body).find(".ul-imagelib-data").off("scroll").end().remove(),t._newPage("stock",!1),t.currentStockOffset=t.stockDefaultLimit},function(){a.removeAttr("disabled"),e("[data-page=stock]",t.vars.$body).removeClass("loading")})}).on("keypress.imgLib","#js-photostock-search",function(a){if(13===a.keyCode&&e(this).val()){var i=e(this).attr("disabled","disabled"),o=i.val();e("[data-page=stock]",t.vars.$body).addClass("loading"),t._loadStockPhotos("/api/depositphotos/search/?query="+o,0,function(){i.removeAttr("disabled"),e("[data-page=stock]",t.vars.$body).find(".ul-imagelib-data").off("scroll").end().remove(),t._newPage("stock",!1),t.currentStockOffset=t.stockDefaultLimit},function(){i.removeAttr("disabled"),e("[data-page=stock]",t.vars.$body).removeClass("loading")})}})}}(),open:function(){return function(a){var i=this;i.opt=e.extend({appendTo:null,page:"loaded",lim:24,socialLim:30,multiSelect:!0,afterOpen:function(){return function(){}}(),close:function(){return function(){}}(),apply:function(){return function(){}}()},a),null==i.$el?i.init():i._show()}}(),_loadData:function(){return function(i){var t=this;t.vars.data?i():e.ajax({url:a.sprintf("/sites/url/{site}/imageLib/list",[a.params.site]),api:!0,ok:function(){return function(a){a.stock&&a.stock.length&&(t.stockPhotosCurrentCat=a.categoryId,t.currentStockOffset=a.stock.length,t.stockPhotosUrlToLoad="/api/depositphotos/categories/"+a.categoryId);var e="social";Object.keys(a).forEach(function(i){i===e?(t.vars.pages[e]={innerPages:{}},Object.keys(a[e].auth).forEach(function(i){t.vars.pages[e].innerPages[i]={albums:a[e].auth[i]}}),t.vars.pages[e].notAuth=a[e].notAuth):(t.vars.pages[i]={},t.vars.pages[i].data=a[i])}),i()}}()})}}(),_addDataToSocial:function(){return function(t,s){var l=this,n=l.vars.pages.social.innerPages[t].$el.find('.ul-imagelib-social-group[data-id="'+s+'"] ul'),r=l.vars.pages.social.innerPages[t].albums.filter(function(a){return l._getSocialMap("albumId",t,a)==s?a:void 0})[0];null==r.visible&&(r.visible=0),n.addClass("loading");var d;d="vkontakte"===t?o("/sites/url/{site}/api/{social}/albums/{id}?offset={offset}&count={count}",[a.params.site,t,s,r.visible,l.opt.socialLim]):o("/sites/url/{site}/api/{social}/albums/{id}?limit={limit}&offset={offset}",[a.params.site,t,s,l.opt.socialLim,r.visible]),e.ajax({url:d,api:!0,ok:function(){return function(a){var o=l.vars.pages.social.innerPages[t].$el.find('.ul-imagelib-social-group[data-id="'+s+'"] .ul-imagelib-social-loadmore');a.length&&(a.forEach(function(a){e(i.template(c,{img:{origin:l._getSocialMap("imgOrigin",t,a),thumb:l._getSocialMap("imgThumb",t,a)}})).appendTo(n).addClass("added")}),setTimeout(function(){l.$el.find(".added").removeClass("added")},1e3),r.visible+=a.length,l._getSocialMap("albumSize",t,r)-r.visible>l.opt.socialLim?o.find("span").html(l.opt.socialLim):(0>=l._getSocialMap("albumSize",t,r)-r.visible&&o.hide(),o.find("span").html(l._getSocialMap("albumSize",t,r)-r.visible))),n.removeClass("loading")}}()})}}(),_page:function(){return function(a){var i=this;null==i.vars.pages[a].$el&&i._newPage(a,!1),i.vars.$nav.find("li").removeClass("active"),i.vars.$nav.find('li[data-nav="'+a+'"]').addClass("active"),i.vars.$body.find(".ul-imagelib-page").hide(),i.vars.curPage=a,i.vars.pages[a].$el.show(),"stock"===a?(i.vars.$body.addClass("ul-imagelib-pages--small"),e(".js-stocknav",i.$el).show(),!i.vars.stockInited&&e.ajax({url:"/api/depositphotos/categories",api:!0,ok:function(){return function(a){var t="";i.vars.stockInited=!0,Object.keys(a).forEach(function(e){t+='<option value="'+e+'">'+a[e]+"</option>"}),e("#js-photostock-select",i.$el).append(t).show().val(i.stockPhotosCurrentCat).parent().removeAttr("disabled"),u.selects(e(".ul-select-link",i.$el))}}(),noOk:function(){return function(){console.error("Error")}}()})):(i.vars.$body.removeClass("ul-imagelib-pages--small"),e(".js-stocknav",i.$el).hide())}}(),_newPage:function(){return function(a,t){var o=this;if("social"===a)o.vars.$body.append(e(i.template(n,{auth:Object.keys(o.vars.pages.social.innerPages),notAuth:o.vars.pages.social.notAuth,__ci:o.i18n,__:o.__}))),o.vars.pages.social.$el=o.vars.$body.find('.ul-imagelib-page[data-page="social"]'),Object.keys(o.vars.pages.social.innerPages).forEach(function(a){o._addSocial(a)}),o._socialPage(),o.vars.$containerBlock.on("click.imgLib",".js-imagelib-social-nav li",function(){o._socialPage(e(this).data("social-nav"))}).on("click.imgLib","a.js-imagelib-social-delete",function(){return o._deleteSocial(e(this).attr("href")),!1}).on("click.imgLib",".ul-imagelib-social-group-preview",function(){var a,i,t,s;a=e(this),i=e(this).parents(".ul-imagelib-social-group"),t=i.data("id"),s=e(this).parents(".ul-imagelib-data").data("social"),i.find(".ul-imagelib-img-list ul li").length||o._addDataToSocial(s,t),i.toggleClass("active"),i.hasClass("active")&&i.parents(".ul-imagelib-data").animate({scrollTop:i.position().top-e(this).height()/2+i.parents(".ul-imagelib-data").scrollTop()+17},500)}).on("click.imgLib",".ul-imagelib-social-loadmore",function(){var a=e(this).parents(".ul-imagelib-social-group").data("id"),i=e(this).parents(".ul-imagelib-data").data("social");o._addDataToSocial(i,a)}),o._toggleBtnAddSocial(),o._handleClickAddSocial();else{var s=o.vars.pages[a];"stock"===a&&t?(s.$el=o.vars.$body.find('.ul-imagelib-page[data-page="'+a+'"]'),e("ul",s.$el).append(e(i.template("<% _.each(data, function (image) { %><%- _.template(imgT, { img: image }) %><% }) %>",{data:s.data.concat().splice(0,36),imgT:c})))):(o.vars.$body.append(e(i.template(l,{page:a,data:s.data.concat().splice(0,36),imgT:c,__:o.i18n}))),s.$el=o.vars.$body.find('.ul-imagelib-page[data-page="'+a+'"]'),s.$el.find(".ul-imagelib-data").scrollTop(0),setTimeout(function(){s.$el.find(".ul-imagelib-data").on("scroll",function(t){t.preventDefault();var l=e(this).find(".ul-imagelib-img-list"),n=l.find("ul"),r=l.height()-e(this).height(),d=[];e(this).scrollTop()>r-40&&(0<s.data.length-s.visible?(d=s.data.concat().slice(s.visible,s.visible+o.opt.lim),d.forEach(function(a){e(i.template(c,{img:a})).appendTo(n).addClass("added")}),setTimeout(function(){o.$el.find(".added").removeClass("added")},1e3),s.visible+=d.length):"stock"===a&&!o.pending&&o.stockPhotosUrlToLoad&&(o.pending=!0,e("[data-page=stock]",o.vars.$body).addClass("loading-more"),o._loadStockPhotos(o.stockPhotosUrlToLoad,o.currentStockOffset,function(){o._newPage("stock",!0),o.currentStockOffset+=o.stockDefaultLimit,o.pending=!1,e("[data-page=stock]",o.vars.$body).removeClass("loading-more")},function(){o.pending=!1,e("[data-page=stock]",o.vars.$body).removeClass("loading-more")})))})},100)),s.visible=36<s.data.length?36:s.data.length}}}(),_handleClickAddSocial:function(){return function(){var i=this;e(i.$el).on("change.imgLib",".ul-imagelib-social-add select",function(){var i=e(this).val();"none"!==i&&(e(this).val("none"),window.open(o("/sites/url/{site}/api/{val}/add",[a.params.site,i]),null,["width=660","height=380","resizable=yes","status=yes","location=no","toolbar=no"].join(",")))})}}(),_loadStockPhotos:function(){return function(a,i,t,o){var s=this;e.ajax({url:a,api:!0,data:{limit:s.stockDefaultLimit,offset:i},ok:function(){return function(e){s.stockPhotosUrlToLoad=a;var i=e.map(function(a){return{thumb:a.medium_thumbnail,origin:a.url_big,itemurl:a.itemurl}});s.vars.pages.stock.data=i,t&&t()}}(),noOk:function(){return function(a){console.error("Error",a),o&&o()}}(),error:function(){return function(a){console.error("Error",a),o&&o()}}()})}}(),_addSocial:function(){return function(a){var t=this;t.vars.pages.social.$el.append(e(i.template(r,{social:a,albums:t.vars.pages.social.innerPages[a].albums,lim:t.opt.socialLim,imgT:c,_map:t._getSocialMap,__:t.i18n}))),t.vars.pages.social.innerPages[a].$el=t.vars.pages.social.$el.find('.ul-imagelib-data[data-social="'+a+'"]')}}(),_deleteSocial:function(){return function(i){var t=this;e.ajax({url:a.sprintf("/sites/url/{site}/api/{social}/delete",[a.params.site,i]),method:"get",api:!0,ok:function(){return function(){t.vars.pages.social.notAuth[i]="/sites/url/"+a.params.site+"/api/vkontakte/add",e(".ul-imagelib-social-add select",t.vars.pages.social.$el).append(e('<option value="'+i+'">'+t.__("all.oauth."+i)+"</option>")),t.vars.pages.social.$el.find('.ul-imagelib-social-controls li[data-social-nav="'+i+'"]').remove(),t.vars.pages.social.$el.find(".js-social-"+i).remove(),t._handleClickAddSocial(),t._toggleBtnAddSocial()}}()})}}(),_getSocialMap:function(){return function(a,e,i){var t=function(){return function(a){var e=a.sizes.map(function(a){return _extends({},a,{square:a.width*a.height})}).sort(function(a,e){return e.square-a.square});return e[0].url}}(),o={albumId:{vkontakte:function(){return function(){return i.id}}(),facebook:function(){return function(){return i.aid}}()},albumPreview:{vkontakte:function(){return function(){return i.thumb_src}}(),facebook:function(){return function(){return i.thumb_src}}()},albumTitle:{vkontakte:function(){return function(){return i.title}}(),facebook:function(){return function(){return i.title}}()},albumSize:{vkontakte:function(){return function(){return i.size}}(),facebook:function(){return function(){return i.size}}()},imgOrigin:{vkontakte:function(){return function(){return t(i)}}(),facebook:function(){return function(){return i.src_xxbig||i.src_xbig||i.src_big}}()},imgThumb:{vkontakte:function(){return function(){return t(i)}}(),facebook:function(){return function(){return i.src||i.src_small||i.src_big}}()}};return o[a][e]()}}(),_socialPage:function(){return function(a){var i=this;if(null!=a||(a=i.$el.find(".js-imagelib-social-nav li:first").data("social-nav"),null!=a)){var t=i.vars.pages.social.innerPages[a].$el;e(".ul-imagelib-data",i.vars.pages.social.$el).hide(),t.show(),e(".js-imagelib-social-nav li",i.vars.pages.social.$el).removeClass("active"),e('.js-imagelib-social-nav li[data-social-nav="'+a+'"]',i.vars.pages.social.$el).addClass("active")}}}(),_setUploader:function(){return function(){var a=this;a.uploaderInit||(a.vars.uploader=new t({eventsContext:a.vars.$containerBlock,$renderedTo:a.$el.find(".ul-imagelib-dropZone"),libBtn:!1,fileTypes:["image/jpeg","image/png","image/gif","image/bmp"],fileExtensions:[".jpg",".jpeg",".png",".gif",".bmp"],urlUploader:!0,name:"imageLib",statusText:{normal:{title:d("constructor.from computer"),description:d("constructor.drop file here for replace")}}}),a.vars.uploader.init(),a.uploaderInit=!0)}}(),_addUploaded:function(){return function(a){var t=this;t._page("loaded");var o=t.vars.$body.find(".ul-imagelib-img").map(function(a,i){return e(i).attr("data-img")}).toArray();a.filter(function(a){return-1===o.indexOf(a.origin)}).forEach(function(a){t._setSelectedImages(e(i.template(c,{img:a})).prependTo(t.vars.pages.loaded.$el.find(".ul-imagelib-img-list ul")).addClass("added")),setTimeout(function(){t.$el.find(".added").removeClass("added")},1e3),delete a._id,t.vars.pages.loaded.data.unshift(a),++t.vars.pages.loaded.visible}),t.vars.pages.loaded.$el.find(".ul-imagelib-data").scrollTop(0),t._checkEmptyLoaded()}}(),_clearSelectedImages:function(){return function(){var a=this;a.$el.find(".ul-imagelib-img-list li").removeClass("active"),a.vars.images=[],a.vars.$conut.hide().find("span").html(0),a.vars.$done.attr("disabled","disabled")}}(),_setSelectedImages:function(){return function(a){var i=this;i.opt.multiSelect?a.toggleClass("active"):a.hasClass("active")?a.removeClass("active"):(i._clearSelectedImages(),a.addClass("active")),i.vars.images=[],i.$el.find(".ul-imagelib-img-list li.active").each(function(){i.vars.images.push({origin:e(this).find(".ul-imagelib-img").data("img"),thumb:e(this).find(".ul-imagelib-img").data("thumb")})}),i.vars.images.length?(i.vars.$conut.show().find("span").html(i.i18n("count images",i.vars.images.length)),i.vars.$done.removeAttr("disabled")):i._clearSelectedImages()}}(),_show:function(){return function(){var i=this;i._clearSelectedImages(),i.$detached?i.vars.$containerBlock.append(i.$detached):i.$el.show(),a.layers.on(1,e.proxy(i._hide,i)),i.opt.afterOpen(),window.closeOpenedWindow=function(a){e(window).trigger("_okAuth",a)},e(window).on("_okAuth",i.okAuth),i.shown=!0,g.add({fromFile:"js/ulib/imagelib.js",title:"imagelib show"})}}(),_hidePreview:function(){return function(){var a=this;a.vars.$preview.removeClass("ul-imagelib-preview-show").find("img").attr("src","")}}(),_checkEmptyLoaded:function(){return function(){var a=this;a.vars.pages.loaded.$el.find(".ul-imagelib-img-list ul li").length?a.vars.pages.loaded.$el.removeClass("ul-imagelib-empty-page"):a.vars.pages.loaded.$el.addClass("ul-imagelib-empty-page")}}(),okAuth:function(){return function(i,t){var o=m,s=i.detail||t.detail,l=e(".js-imagelib-social-nav",o.vars.pages.social.$el);o.vars.pages.social.$el.addClass("loading"),l.find(".js-imagelib-social-nav-add").blur(),o.vars.pages.social.$el.removeClass("ul-imagelib-empty-page"),e.ajax({url:"/sites/url/"+a.params.site+"/api/"+s+"/albums",api:!0,ok:function(){return function(a){o.vars.pages.social.innerPages[s]={albums:a},o._addSocial(s),l.append('<li data-social-nav="'+s+'">'+o.__("all.oauth."+s)+'<a href="'+s+'" class="ul-select-button-small js-imagelib-social-delete icon-content-special-cross-small"></a></li>');var e=o.vars.pages.social.$el.find(".ul-imagelib-social-add select");e.find('option[value="'+s+'"]').remove(),o._toggleBtnAddSocial(),o._socialPage(s),o.vars.pages.social.$el.removeClass("loading")}}()})}}(),_toggleBtnAddSocial:function(){return function(){var a=this,e=a.$el.find(".ul-imagelib-social-add");1>=e.find("option").length?(e.addClass("hide"),e.addClass("blabla")):e.removeClass("hide")}}(),_hide:function(){return function(){var a=this;a.$detached=a.$el.detach(),a.opt.close(),window.removeEventListener("_okAuth",a.okAuth,!1),e(window).off("_okAuth"),a.shown=!1,e(".ul-imagelib-loading",a.$el).hide(),g.add({fromFile:"js/ulib/imagelib.js",title:"imagelib hide"})}}()};return m});
//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map

//# sourceMappingURL=imagelib.js.map
